# 持久化 Persistence

持久化就是把内存中的数据保存到磁盘中, 这样就算服务器重启也能保证数据不丢失.

在Redis中, 主要有三种持久化方法:
1. AOF (Append Only File)
2. RDB Snapshot
3. aof-use-rdb-preamble

---

# AOF

Append Only File 持久化是把所有的**写操作命令**存入一个文件中, 这样恢复的时候只需要重新按顺序执行文件中的命令即可.

其顺序是先执行写操作, 再把操作记录进文件.

| 优点 | 缺点 |
|---|---|
| 避免额外的检查开销: 如果写入失败则不用记录该操作 | 丢失风险: 如果写入完成后记录操作失败则可能在恢复时丢失数据 |
| 不会阻塞当前写操作 | 可能阻塞后面的写操作 |

## 写回策略

写回策略 &rarr; 把内存数据写入磁盘的策略.

|策略|时机|优点|缺点|
|---|---|---|---|
|Always|每一个操作都写回|可靠性好, 丢失率低|性能差|
|Everysec|通过异步任务每秒写回|||
|No|操作系统控制|性能高|可靠性差|

数据实际上被放在内核缓存区, 由内核调用`fsync()`去写入磁盘, 这三种策略的差别就是何时调用`fsync()`.

---

## 重写机制

Redis不可能把每条操作都记录并在恢复时全部执行, 这样文件只会越来越大, 开销越来越不能接受.

**AOF重写机制就是压缩AOF文件大小的机制**. 即不论某个键值对经过多少次更改, 重写后的AOF只需要记录内存中最新的状态即可.

```
set X 10 => log "X = 10" in AOF
set X 100 => log "X = 100" in AOF
AOF重写 => 扫描内存, log "X = 100" 到新的AOF文件, 然后覆盖旧的
```

AOF重写时需要先写入一个新的文件, 完成后再覆盖, 否则会污染已有的AOF.

该过程被放入后台子进程避免阻塞主进程.

> [!IMPORTANT]
> **Q**: 为什么使用子进程而非线程呢?
> 
> **A**: 线程会共享内存, 需要加锁, 这会影响效率; 子进程和父进程的共享数据只读, 任意一方更改数据会出发"**写时复制 COW (Copy On Write)**"创建独立数据备份. 具体就是父进程复制一份虚拟页表给子进程, 父子页表指向相同物理空间且只读, 当修改数据时才复制物理空间.

重写的问题在于:
1. 当AOF重写机制生效时, 如果主进程修改一个大key, 那么触发COW复制物理空间会耗时, 导致主进程阻塞
2. 主进程修改的键值对和子进程的不一致

针对第二个问题, Redis设计了**AOF重写缓冲区**. 即主进程的工作:
1. 执行命令修改内存数据 (可能触发COW)
2. 追加命令到AOF缓冲区
3. 追加命令到AOF重写缓冲区 (只在重写的过程中使用, 重写未触发则不执行该指令, 相当于保存“子进程运行之后, 完成之前”的最新的修改记录)

那么子进程完成对AOF重写 (*扫描内存, 将最新的键值对数据记录成指令, 写入AOF*) 之后, 子进程发送异步消息给主进程. 主进程收到信号之后执行一个函数:
1. 将AOF重写缓冲区的内容写入新的AOF文件
2. 用新的AOF文件覆盖已有AOF文件

> [!WARNING]
> 该函数会阻塞主进程

---

# RDB

RDB记录**某一个时刻的内存实际数据**. RDB恢复效率更快, 因为不需要再次执行操作而是直接读入数据.

RDB提供两个指令`save`和`bgsave`, 区别在于前者使用主进程执行快照会阻塞, 后者使用子进程.

## 全量快照
RDB是全量快照, 意味着它把内存中所有数据进行持久化, 所以开销较大, 频繁RDB会导致性能下降, 但频率太低又会导致数据丢失过多.

## 一致性
如果使用`save`, 那么具有强一致性, 因为此时只有一个进程, 执行RDB会阻塞进程的更改.

如果使用`bgsave`, 由于存在COW, 所以RDB保存的是子进程数据, 父进程最新更改的数据并不在该次RDB快照中, 存在数据不一致.

---

# aof-use-rdb-preamble (混合持久化)

混合持久化模式下还是使用AOF记录操作到文件, 区别在于AOF重写的时候:
1. 使用RDB快照保存内存数据到AOF文件
2. 同时主进程在快照期间的最新操作被保存在AOF重写缓冲区
3. RDB写入完成后用包含RDB数据和AOF操作的新AOF文件覆盖旧的AOF文件

```
------------
|          |
| RDB 数据 |
|          |
------------
|          |
| AOF 指令 |
|          |
------------
```

---

# AOF vs RDB

||AOF|RDB|
|---|---|---|
|**概念**|记录操作|记录数据|
|**持久化频率**|记录过程, 开销较小, 可以频繁调用|记录内存数据, 开销较大, 不可频繁调用|
|**数据损失**|由于频繁记录, 不容易丢失|由于快照频率低, 容易丢失|
|**数据恢复**|慢, 需要执行操作|快, 直接载入数据|
|**存储开销**|小, 有重写机制|大, 全量快照|
|**阻塞进程**|COW和重写缓冲区函数|save模式 or bgsave模式下的COW|
